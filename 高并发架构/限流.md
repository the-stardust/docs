## 降级

降级的意思就是，当服务器的压力剧增，**为了保证核心功能的正常，而选择性的降低一些功能的可用性，或者直接关闭改功能**，比如
双11当天晚上关闭了退货接口，就是一种降级，比如一些网站关闭改密码，改头像等功能，也是一种降级

一般都会有一个独立的降级系统，可以灵活的配置降级功能，还有就是比较多的代码自动降级，比如接口超时、失败重试多次降级等

## 熔断

降级一般是**我们自身的系统出现故障而降级，而熔断一般是指依赖外部接口出现故障而断绝和外部接口的关系**

比如a服务依赖b服务，但是b服务出现了故障，a服务就要直接切断b服务(直接返回错误，或者默认值)

因为有的服务是一环扣一环，那个服务挂了，如果不进行熔断，也会拖垮这个服务，造成调用链全面崩溃

**熔断的机制还是要根据自身的系统的能力去设定阈值**，比如5分钟内的请求50%都超过1秒啥的

## 限流
限流分为单机限流和分布式限流

降级和熔断都是**受理请求**之后的机制，而限流是直接不接受请求了，拒接请求，或者**使用队列延迟处理**

一般都是**在某个时间段的请求总量到达阈值，进行限流，直接决绝请求**

限流算法也有挺多种类：**计数器算法，令牌桶算法等、滑动窗口算法**

### 计数器算法

laravel和lumen的Throttle中间件实现的就是计算器算法

原理很简单，就是维护一个标识用户和接口的唯一key，比如：sha1(用户ip+接口uri+接口domain+接口method) 

然后对于用户请求，通过中间件过滤，记录访问次数到redis里面，超过限制次数就拒绝请求


### 漏桶算法

水来了(请求)都放到桶里，水多溢出的水就不要了(拒绝服务),桶底有个小洞可以匀速的进行出水(最大处理速度)

常见的漏桶算法都是基于线程池的，可以起到整流左右，**固定线程池大小+固定个数处理线程**来实现

### 令牌桶算法

很多时候我们需要处理突发性增量请求，这时候漏桶就不合适了

令牌桶算法的原理就是以恒定的速率产生令牌，把令牌放到桶里，**消耗不完多余的令牌就丢弃**，来一个请求就消耗一个令牌，
**没有拿到令牌的就拒绝请求**

> 令牌桶算法的一个实现方案是：起一个Timer线程以固定频率往桶中放令牌，桶满时令牌溢出，业务线程在获取令牌时直接从
>桶中获取即可。该方案容易理解，但是需要一个Timer线程，资源占用较重。

php+redis的list可以实现令牌桶，具体方案就是：
- 启动一个守护进程，在一定时间内放入list一些值
- 接口每次调用，去redis里pop一个token，如果失败代表桶里没有令牌了，就拒绝请求
- 可以利用滑动窗口的思想缩短时间间隔

### 区别

令牌桶其实和漏桶很相似，但是还有一些区别

- 漏桶算法能够强行限制数据的传输速率
- 令牌桶能够限制数据的平均传输速率并且**允许一定程度的突发**



