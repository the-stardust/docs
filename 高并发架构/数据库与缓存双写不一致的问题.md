## 前言

现在只要是稍微有点规模的项目，基本上都会使用一系列缓存来缓解数据库的压力，但是一旦碰到高并发场景，就会出现缓存与数据库不一致的情况

![upload successful](http://blogs.xinghe.host/images/pasted-134.png)

系统的查询大概是上图这种步骤，但是在更新缓存的时候，就会有好几种方案了

## 正文

现在主流的方案大概有三种

1. 先更新数据库，再更新缓存
2. 先删除缓存，再更新数据库
3. 先更新数据库，在删除缓存

因为高并发的各种原因，我们几乎是没有办法百分之百保证缓存和数据库永远都是一致的，所以我们写操作全部基于数据库，而读操作基于缓存，给缓存设置过期时间，保证最终一致性即可，缓存这里即使更新失败，到了过期时间之后也会更新到最新数据的，缓存我们只要尽自己最大的努力即可

### 先更新数据库，在更新缓存

这套方案大家是普遍反对的，原因有两种

1.线程安全角度

- 线程1先更新了数据库
- 线程2更新了数据库
- 线程2更新了缓存
- 线程1更新了缓存

>这种情况导致了数据不一致，因为由于一系列原因，线程1更新缓存在线程2更新缓存之后

2.业务场景

1. 如果你的业务场景是写操作居多，而读操作较少，每次你更新数据库的时候，都去更新缓存，但是每次更新完之后不一定都会被读，这么做无疑是在浪费性能，所以不考虑

2. 如果你的数据是经过一系列计算而得来的，每次更新完数据库，还要经过一系列计算再去更新缓存，还不如直接删除缓存来的快

所以我们讨论争议最大的，是先删除缓存再更新数据库还是先更新数据库再删除缓存

### 先删除缓存，再更新数据库

会出现下面的情况

1. 请求1删除缓存
2. 请求2查询发现缓存不存在
3. 请求2查询数据库得到旧值
4. 请求2将旧值写入缓存
5. 请求1更新数据库

如果缓存不设置过期时间，那么查询锁得到的数据将永远是旧数据

这种方案可以采用**延迟双删除策略**解决

- 先删除缓存
- 再更新数据库
- 休眠一段时间
- 再删除缓存

这样上面那种情况下，只有一次或者少数的几次读取缓存里面的是脏数据，最后删除完之后，下次查询会去读取数据库存入新的值

#### 针对休眠时间的设定

这就要根据自己的业务来设置了，一般情况下使用**自己业务读取数据的时间+几百毫秒**就行，这样确保可以删除读取数据造成的脏数据

#### 如果mysql是读写分离架构

会出现
- 请求1去写数据，先删除了缓存，写到了主数据库
- 请求2去读取数据，发现没有缓存
- 请求2去从库读取数据，这时正好主从延迟，从库还是旧数据
- 请求2把旧数据写入缓存，此时缓存里面是脏数据
- 主从数据同步完毕，从库是新值

这就换造成在缓存有效期内都是脏数据，也可以采取**延迟双删除**策略，在主从延迟上面+几百毫秒就行

#### 延迟双删除降低了吞吐量

这样休眠确实会降低吞吐量，那就把第二步删除缓存设置成异步删除，专门启动一个线程，进行异步删除，这样就不用休眠了，增加吞吐量

#### 第二次删除失败怎么办

如果第二次删除缓存失败了，其实第三种策略也会出现，等下下面一起分析

### 先更新数据库，再删除缓存

先更新数据库，再删除缓存，这样子看起来是没有什么问题了，真的么？

1. 缓存刚好失效
2. 请求1去查询数据库，得到一个旧值
3. 请求2将新值写入数据库
4. 请求2删除缓存
5. 请求1把旧值写入缓存

这样子确实会出现脏数据，但是我们分析一下这样的情况什么时候会出现

这样的情况发生，有一个条件是必须的，那就是步骤3的写数据库比步骤2的读数据耗时更短，这样子才能使步骤4比步骤5先发生，而实际情况中，数据库的读操作远远比写操作慢的多，这就是为什么我们做读写分离，就是为什么读远快与写

>但是几率小不代表不出现，我们还是要防范的

那就使用策略2中的异步删除策略，在更新完数据库后，异步休眠一段时间，删除缓存

### 缓存删除失败问题

策略2和策略3的延迟双删除都会出现缓存删除失败的情况，那么如果处理这种情况呢？我google了一下，总结了两种

#### 方案1:重试机制

1. 缓存删除失败
2. 写入消息队列，缓存删除失败的key
3. 业务代码进行消息队列的消费
4. 重试删除key，直到删除成功


这样的缺点就是造成了业务代码的侵入，于是有了方案2

#### 方案2:订阅binlog

1. 业务代码更新了数据库
2. 数据库会写入binlog
3. 订阅程序提取binlog里面我们需要的数据和key
4. 另起一段非业务代码，获取数据和key
5. 尝试删除缓存，如果删除失败
6. 将该信息发送至消息队列
7. 重新从消息队列获取数据，重试删除

上述的订阅binlog程序在mysql中有现成的中间件叫canal，可以完成订阅binlog日志的功能，大致流程如下图所示，图片来自孤独烟的博客：

![upload successful](http://blogs.xinghe.host/images/pasted-135.png)

## 参考

https://www.cnblogs.com/rjzheng/p/9041659.html