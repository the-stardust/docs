## 主从复制原理

涉及三个线程：
1. binlog线程：负责把主服务器上的数据更改写入到二进制日志(binary log)中
2. I/O线程：负责从主服务器上读取二进制日志，并写入到从服务器的中继日志(relay log)中
3. SQL线程：负责读取中继日志，即系出主服务器已经执行的数据更改并在从服务器中重放(Replay)


## 复制的基本原则

1. 每个slave只有一个master
2. 每个slave只能有一个唯一的服务器ID
3. 每个master可以有多个salve
4. 复制的最大问题就是数据延迟，高并发状态下，刚写入的数据会读取不到，因为slave同步数据会有延时

### 有三种同步机制
	
- 异步复制：主库在执行完客户端提交的事务后会立即将结果返给给客户端，并不关心从库是否已经接收并处理，这样就会有一个问题，主如果crash掉了，此时主上已经提交的事务可能并没有传到从上，如果此时，强行将从提升为主，可能导致新主上的数据不完整。
	
- **半同步复制：就是master提交事务后，并写到relay log中才返回给客户端 主要使用这个**<br>
```当Master上开启半同步复制功能时，至少有一个slave开启其功能。当Master向slave提交事务，且事务已写入relay-log中并刷新到磁盘上，slave才会告知Master已收到；若Master提交事务受到阻塞，出现等待超时，在一定时间内Master 没被告知已收到，此时Master自动转换为异步复制机制；
```	
- 全同步复制：指当主库执行完一个事务，所有的从库都执行了该事务才返回给客户端。因为需要等待所有从库执行完该事务才能返回，所以全同步复制的性能必然会
    
## 读写分离
主服务器处理写操作以及实时性要求比较高的读操作，而从服务器处理读操作。

读写分离能提高性能的原因在于：

- 主从服务器负责各自的读和写，极大程度缓解了锁的争用；
- 从服务器可以使用 MyISAM，提升查询性能以及节约系统开销；
- 增加冗余，提高可用性。

> 读写分离常用代理方式来实现，代理服务器接收应用层传来的读写请求，然后决定转发到哪个服务器。

## 主从延迟

1. master的TPS较高，产生大量binlog，slave的sql线程承受不住，那么延时就产生了
2. 大型sql卡主了，slave是单线程，所以会阻塞

### 如何判断主从是否延迟了

1. 通过show slave status\G命令输出的Seconds_Behind_Master参数的值来判断 
    null：表示 io线程或者sql线程有任何一个发生故障
    0：没有延迟
    正值：值越大表示延迟越高，落后主库越多
>但是这个是不太准的，因为Seconds_Behind_Master是比较sql线程和io线程的event的timestamp，得到的差值
>但是如果master上网络阻塞很大，导致不能及时吧binlog同步到relay log中，但是sql线程可以及时同步relay log
>到本地重放，此时Seconds_Behind_Master就是为0，但其实已经产生延迟了

2. mk-heartbeat，Maatkit万能工具包中的一个工具，被认为可以准确判断复制延时的方法。


### 问题产生的原因

1. 因为主从同步使用的是binlog，binlog是顺序写，效率很高
2. slave的I/O线程读取binlog写到relay log中，效率也比较高
3. 问题就产生在slave的sql线程，因为binlog里面记录的ddl、dml的I/O操作都是随机的，成本就高很多，并且slave还有可能
跟本机上的其他查询产生lock竞争，因为sql线程是单线程，所以一个ddl卡主了，执行了10分钟时间，那么之后的ddl都会阻塞
4. 主库的ddl也执行了10分钟为什么不会卡主，是因为master是有并发的，slave的sql线程是单线程

### 解决方案

#### 架构优化
1. 架构上的优化，不要产生大型sql，salve的sql线程是单线程，会卡住
2. 主库会有写操作，需要较高的安全性，比如 sync_binlog = 1，innodb_flush_log_at_trx_commit = 1等设置都会拖慢机器
而slave的安全性就没必要这么高，甚至可以关闭binlog，innodb_flushlog也可以关闭来提高sql执行效率
3. 使用硬件提示slave

#### 实现优化
1. 强制走主库方案
2. sleep方案
3. 判断主备无延迟方案
4. 配合semi-sync方案
5. 等主库位点方案
6. 等GTID方案

[极客时间-Mysql实战45讲-林晓斌](https://time.geekbang.org/column/article/77636)

!> mysql-5.6.3已经支持了多线程的主从复制,但是TPS太高也会拖慢速度